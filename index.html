<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D_Follower's Racing Leaderboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #ff4d94;
            --dark: #1a1a2e;
            --darker: #0f0f1a;
            --light: #f8f9fa;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(to right, var(--accent), var(--secondary), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .admin-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .close-admin {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--light);
            cursor: pointer;
        }

        .admin-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .admin-section {
            flex: 1;
            min-width: 300px;
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--accent);
            font-weight: 600;
        }

        .upload-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, var(--success), #20c997);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .winner-photo-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .file-name {
            margin-top: 5px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .day-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .reset-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        .day-selector, .search-box, .admin-access {
            flex: 1;
            min-width: 300px;
        }

        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .day-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            font-weight: 500;
        }

        .day-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        .admin-access-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, var(--accent), #ff6b9d);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .winner-spotlight {
            background: linear-gradient(135deg, rgba(106, 17, 203, 0.2), rgba(37, 117, 252, 0.2));
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .winner-title {
            font-size: 2rem;
            margin-bottom: 25px;
            color: var(--gold);
            font-weight: 700;
        }

        .winner-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .winner-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--gold);
        }

        .winner-info {
            text-align: left;
        }

        .winner-name {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--gold), #ffed4e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .winner-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .leaderboard-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 40px;
        }

        .leaderboard-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--light);
        }

        .day-info {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(0, 0, 0, 0.3);
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            cursor: pointer;
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        td {
            padding: 15px;
        }

        .rank-cell {
            font-weight: 700;
            text-align: center;
            width: 80px;
        }

        .rank-1 { color: var(--gold); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }

        .medal-cell {
            text-align: center;
            width: 100px;
        }

        .medal {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .medal-gold {
            background: var(--gold);
            color: #8a6d00;
        }

        .medal-silver {
            background: var(--silver);
            color: #5a5a5a;
        }

        .medal-bronze {
            background: var(--bronze);
            color: #5a3c00;
        }

        .time-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
        }

        .login-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .login-content {
            background: var(--dark);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            color: var(--accent);
        }

        .login-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(to right, var(--success), #20c997);
        }

        .notification.error {
            background: linear-gradient(to right, var(--danger), #e83e8c);
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .control-row, .admin-controls { flex-direction: column; }
            .winner-content { flex-direction: column; text-align: center; }
            .winner-info { text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">D_Follower's Game</h1>
            <p class="subtitle">Track your racing performance and climb the leaderboard!</p>
        </header>

        <!-- Admin Panel -->
        <section class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h2 class="admin-title">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </h2>
                <button class="close-admin" id="closeAdmin">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-controls">
                <div class="admin-section">
                    <div class="section-title">
                        <i class="fas fa-file-csv"></i> Upload Race Results
                    </div>
                    <button class="upload-btn" id="uploadBtn">
                        <i class="fas fa-cloud-upload-alt"></i> Select CSV File
                    </button>
                    <div class="file-name" id="fileName">No file selected</div>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    
                    <div class="section-title" style="margin-top: 20px;">
                        <i class="fas fa-camera"></i> Winner Photo Upload
                    </div>
                    <button class="winner-photo-btn" id="winnerPhotoBtn">
                        <i class="fas fa-image"></i> Select Winner Photo
                    </button>
                    <div class="file-name" id="winnerPhotoName">No photo selected</div>
                    <input type="file" id="winnerPhotoFile" accept="image/*" style="display: none;">
                </div>
                
                <div class="admin-section">
                    <div class="section-title">
                        <i class="fas fa-calendar-plus"></i> Day Management
                    </div>
                    <input type="text" class="day-input" id="dayName" placeholder="Enter day name (e.g., Day 1, Finals)">
                    <div class="admin-actions">
                        <button class="action-btn save-btn" id="saveDay">
                            <i class="fas fa-save"></i> Save Day with CSV
                        </button>
                        <button class="action-btn reset-btn" id="resetForm">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>

                    <div class="section-title" style="margin-top: 20px;">
                        <i class="fas fa-cloud-upload-alt"></i> Update Public Data
                    </div>
                    <button class="upload-btn" id="exportGitHubBtn">
                        <i class="fas fa-download"></i> Export Data for GitHub
                    </button>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 10px;">
                        After exporting, upload data.json to GitHub to update everyone.
                    </p>
                </div>
            </div>
        </section>

        <section class="controls">
            <div class="control-row">
                <div class="day-selector">
                    <div class="section-title">
                        <i class="fas fa-calendar-alt"></i> Select Day
                    </div>
                    <div class="day-buttons" id="dayButtons">
                        <!-- Days will appear here -->
                    </div>
                </div>
                
                <div class="search-box">
                    <div class="section-title">
                        <i class="fas fa-search"></i> Search Player
                    </div>
                    <input type="text" id="searchInput" placeholder="Enter username or full name...">
                </div>
                
                <div class="admin-access">
                    <div class="section-title">
                        <i class="fas fa-user-cog"></i> Administrator
                    </div>
                    <button class="admin-access-btn" id="adminAccessBtn">
                        <i class="fas fa-lock"></i> Admin Access
                    </button>
                </div>
            </div>
        </section>

        <section class="winner-spotlight">
            <h2 class="winner-title">
                <i class="fas fa-trophy"></i> <span id="winnerDayTitle">Today's</span> Winner
            </h2>
            <div class="winner-content">
                <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80" 
                     alt="Winner Avatar" class="winner-avatar" id="winnerAvatar">
                <div class="winner-info">
                    <h3 class="winner-name" id="winnerName">Racing_Pro_23</h3>
                    <p id="winnerDescription">Finished in 12.45 seconds with perfect racing lines!</p>
                    <div class="winner-stats">
                        <div class="stat">
                            <div class="stat-value" id="winnerTime">12.45s</div>
                            <div class="stat-label">Finish Time</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="winnerLane">Lane 4</div>
                            <div class="stat-label">Position</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="winnerMedal">🥇</div>
                            <div class="stat-label">Gold Medal</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="leaderboard-container">
            <div class="leaderboard-header">
                <h2 class="leaderboard-title">
                    <i class="fas fa-list-ol"></i> Race Leaderboard
                </h2>
                <div class="day-info" id="currentDayInfo">Day 1</div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Time (s)</th>
                            <th>Frames</th>
                            <th>Lane</th>
                            <th>Medal</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Data will appear here -->
                    </tbody>
                </table>
            </div>
        </section>

        <footer>
            <p>D_Follower's Game Leaderboard &copy; 2023 | Professional Racing Leaderboard System</p>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <h2 class="login-title">
                <i class="fas fa-lock"></i> Admin Login
            </h2>
            <input type="password" class="login-input" id="adminPassword" placeholder="Enter admin password">
            <button class="login-btn" id="loginBtn">Login</button>
            <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
        </div>
    </div>

    <script>
        // ==================== APPLICATION STATE ====================
        const appState = {
            days: {},
            currentDay: null,
            currentData: [],
            isAdmin: false,
            adminPassword: 'admin123'
        };

        // ==================== DOM ELEMENTS ====================
        const elements = {};

        // ==================== CORE FUNCTIONS ====================

        function initApp() {
            loadAllElements();
            setupAllEventListeners();
            loadInitialData();
            showNotification('Leaderboard System Ready!', 'success');
        }

        function loadAllElements() {
            const elementIds = [
                'leaderboardBody', 'searchInput', 'dayButtons', 'adminAccessBtn',
                'adminPanel', 'closeAdmin', 'uploadBtn', 'csvFile', 'fileName', 
                'dayNameInput', 'saveDayBtn', 'resetFormBtn', 'loginModal', 
                'adminPasswordInput', 'loginBtn', 'loginError', 'currentDayInfo',
                'winnerDayTitle', 'winnerAvatar', 'winnerName', 'winnerDescription',
                'winnerTime', 'winnerLane', 'winnerMedal', 'winnerPhotoBtn',
                'winnerPhotoFile', 'winnerPhotoName', 'exportGitHubBtn'
            ];

            elementIds.forEach(id => {
                elements[id] = document.getElementById(id);
            });

            // Fix ID mismatches
            elements.dayNameInput = document.getElementById('dayName');
            elements.saveDayBtn = document.getElementById('saveDay');
            elements.resetFormBtn = document.getElementById('resetForm');
            elements.adminPasswordInput = document.getElementById('adminPassword');
        }

        function setupAllEventListeners() {
            // Admin Access
            elements.adminAccessBtn?.addEventListener('click', showLoginModal);
            elements.loginBtn?.addEventListener('click', handleAdminLogin);
            elements.closeAdmin?.addEventListener('click', hideAdminPanel);

            // File Uploads
            elements.uploadBtn?.addEventListener('click', () => elements.csvFile?.click());
            elements.csvFile?.addEventListener('change', handleFileSelect);
            elements.winnerPhotoBtn?.addEventListener('click', () => elements.winnerPhotoFile?.click());
            elements.winnerPhotoFile?.addEventListener('change', handleWinnerPhotoSelect);

            // Day Management
            elements.saveDayBtn?.addEventListener('click', handleSaveDay);
            elements.resetFormBtn?.addEventListener('click', resetForm);

            // Search
            elements.searchInput?.addEventListener('input', handleSearch);

            // Export
            elements.exportGitHubBtn?.addEventListener('click', exportDataForGitHub);

            // Modal close
            elements.loginModal?.addEventListener('click', (e) => {
                if (e.target === elements.loginModal) hideLoginModal();
            });

            // Enter key in login
            elements.adminPasswordInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });
        }

        function loadInitialData() {
            const savedData = localStorage.getItem('racingLeaderboardData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    appState.days = parsed.days || {};
                    appState.currentDay = parsed.currentDay;
                    
                    if (Object.keys(appState.days).length === 0) {
                        createSampleData();
                    } else {
                        const firstDay = Object.keys(appState.days)[0];
                        if (!appState.currentDay) appState.currentDay = firstDay;
                        appState.currentData = [...appState.days[appState.currentDay].data];
                    }
                } catch (e) {
                    createSampleData();
                }
            } else {
                createSampleData();
            }
            
            updateDisplay();
        }

        function createSampleData() {
            const sampleData = [
                { rank: 1, username: "Racing_Pro", full_name: "Alex Johnson", finish_time_seconds: 12.45, finish_time_frames: 747, lane_position: 4, medal: "Gold" },
                { rank: 2, username: "Speed_Demon", full_name: "Maria Garcia", finish_time_seconds: 12.67, finish_time_frames: 760, lane_position: 2, medal: "Silver" },
                { rank: 3, username: "Track_Master", full_name: "David Smith", finish_time_seconds: 12.89, finish_time_frames: 773, lane_position: 7, medal: "Bronze" }
            ];

            const dayKey = 'day_' + Date.now();
            appState.days[dayKey] = {
                name: "Sample Race Day",
                data: sampleData,
                winnerPhoto: null
            };
            appState.currentDay = dayKey;
            appState.currentData = sampleData;
            
            saveToLocalStorage();
        }

        // ==================== CSV HANDLING ====================

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                elements.fileName.textContent = file.name;
            }
        }

        function handleSaveDay() {
            if (!elements.csvFile.files[0]) {
                showNotification('Please select a CSV file first!', 'error');
                return;
            }

            const dayName = elements.dayNameInput.value.trim() || `Day ${Object.keys(appState.days).length + 1}`;
            const file = elements.csvFile.files[0];
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = parseCSV(e.target.result);
                    if (csvData.length > 0) {
                        const dayKey = 'day_' + Date.now();
                        appState.days[dayKey] = {
                            name: dayName,
                            data: csvData,
                            winnerPhoto: null
                        };
                        
                        appState.currentDay = dayKey;
                        appState.currentData = csvData;
                        
                        saveToLocalStorage();
                        updateDisplay();
                        resetForm();
                        
                        showNotification(`"${dayName}" created successfully with ${csvData.length} racers!`, 'success');
                    } else {
                        showNotification('No valid data found in CSV file', 'error');
                    }
                } catch (error) {
                    showNotification('Error parsing CSV file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredHeaders = ['rank', 'username', 'full_name', 'finish_time_seconds', 'finish_time_frames', 'lane_position', 'medal'];
            
            for (let header of requiredHeaders) {
                if (!headers.includes(header)) {
                    throw new Error(`Missing required column: ${header}`);
                }
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if (['rank', 'finish_time_seconds', 'finish_time_frames', 'lane_position'].includes(header)) {
                            value = Number(value) || 0;
                        }
                        entry[header] = value;
                    });
                    data.push(entry);
                }
            }

            return data.sort((a, b) => a.rank - b.rank);
        }

        // ==================== WINNER PHOTO HANDLING ====================

        function handleWinnerPhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file!', 'error');
                    return;
                }
                
                elements.winnerPhotoName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (appState.currentDay && appState.days[appState.currentDay]) {
                        appState.days[appState.currentDay].winnerPhoto = e.target.result;
                        elements.winnerAvatar.src = e.target.result;
                        saveToLocalStorage();
                        showNotification('Winner photo updated!', 'success');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // ==================== DISPLAY FUNCTIONS ====================

        function updateDisplay() {
            renderLeaderboard();
            renderDayButtons();
            updateWinnerSpotlight();
            updateCurrentDayInfo();
        }

        function renderLeaderboard() {
            if (!elements.leaderboardBody) return;
            
            elements.leaderboardBody.innerHTML = '';
            
            if (!appState.currentData || appState.currentData.length === 0) {
                elements.leaderboardBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No data available</td></tr>';
                return;
            }

            appState.currentData.forEach(player => {
                const row = document.createElement('tr');
                let medalClass = '';
                if (player.medal === 'Gold') medalClass = 'medal-gold';
                else if (player.medal === 'Silver') medalClass = 'medal-silver';
                else if (player.medal === 'Bronze') medalClass = 'medal-bronze';

                row.innerHTML = `
                    <td class="rank-cell rank-${player.rank}">${player.rank}</td>
                    <td>${player.username}</td>
                    <td>${player.full_name}</td>
                    <td class="time-cell">${player.finish_time_seconds.toFixed(2)}s</td>
                    <td>${player.finish_time_frames}</td>
                    <td>${player.lane_position}</td>
                    <td class="medal-cell">
                        ${player.medal !== 'None' ? `<span class="medal ${medalClass}">${player.medal}</span>` : '-'}
                    </td>
                `;
                elements.leaderboardBody.appendChild(row);
            });
        }

        function renderDayButtons() {
            if (!elements.dayButtons) return;
            
            elements.dayButtons.innerHTML = '';
            Object.keys(appState.days).forEach(dayKey => {
                const day = appState.days[dayKey];
                const button = document.createElement('button');
                button.className = `day-btn ${appState.currentDay === dayKey ? 'active' : ''}`;
                button.textContent = day.name;
                button.onclick = () => changeDay(dayKey);
                elements.dayButtons.appendChild(button);
            });
        }

        function updateWinnerSpotlight() {
            if (!appState.currentDay || !appState.days[appState.currentDay]) return;
            
            const day = appState.days[appState.currentDay];
            const winner = day.data[0];
            if (!winner) return;

            if (elements.winnerDayTitle) elements.winnerDayTitle.textContent = day.name + "'s";
            if (elements.winnerName) elements.winnerName.textContent = winner.username;
            if (elements.winnerDescription) elements.winnerDescription.textContent = `Finished in ${winner.finish_time_seconds.toFixed(2)} seconds!`;
            if (elements.winnerTime) elements.winnerTime.textContent = `${winner.finish_time_seconds.toFixed(2)}s`;
            if (elements.winnerLane) elements.winnerLane.textContent = `Lane ${winner.lane_position}`;
            if (elements.winnerMedal) elements.winnerMedal.textContent = winner.medal === 'Gold' ? '🥇' : winner.medal === 'Silver' ? '🥈' : '🥉';
            
            if (elements.winnerAvatar && day.winnerPhoto) {
                elements.winnerAvatar.src = day.winnerPhoto;
            }
        }

        function updateCurrentDayInfo() {
            if (elements.currentDayInfo && appState.currentDay && appState.days[appState.currentDay]) {
                elements.currentDayInfo.textContent = appState.days[appState.currentDay].name;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================

        function changeDay(dayKey) {
            if (appState.days[dayKey]) {
                appState.currentDay = dayKey;
                appState.currentData = [...appState.days[dayKey].data];
                updateDisplay();
            }
        }

        function handleSearch() {
            const term = elements.searchInput.value.toLowerCase();
            if (!term) {
                renderLeaderboard();
                return;
            }
            
            const filtered = appState.currentData.filter(player => 
                player.username.toLowerCase().includes(term) || 
                player.full_name.toLowerCase().includes(term)
            );
            
            // Temporary render filtered results
            const tempBody = elements.leaderboardBody;
            tempBody.innerHTML = '';
            filtered.forEach(player => {
                const row = document.createElement('tr');
                let medalClass = '';
                if (player.medal === 'Gold') medalClass = 'medal-gold';
                else if (player.medal === 'Silver') medalClass = 'medal-silver';
                else if (player.medal === 'Bronze') medalClass = 'medal-bronze';

                row.innerHTML = `
                    <td class="rank-cell rank-${player.rank}">${player.rank}</td>
                    <td>${player.username}</td>
                    <td>${player.full_name}</td>
                    <td class="time-cell">${player.finish_time_seconds.toFixed(2)}s</td>
                    <td>${player.finish_time_frames}</td>
                    <td>${player.lane_position}</td>
                    <td class="medal-cell">
                        ${player.medal !== 'None' ? `<span class="medal ${medalClass}">${player.medal}</span>` : '-'}
                    </td>
                `;
                tempBody.appendChild(row);
            });
        }

        function resetForm() {
            elements.dayNameInput.value = '';
            elements.fileName.textContent = 'No file selected';
            elements.winnerPhotoName.textContent = 'No photo selected';
            elements.csvFile.value = '';
            elements.winnerPhotoFile.value = '';
        }

        function saveToLocalStorage() {
            const dataToSave = {
                days: appState.days,
                currentDay: appState.currentDay
            };
            localStorage.setItem('racingLeaderboardData', JSON.stringify(dataToSave));
        }

        // ==================== ADMIN FUNCTIONS ====================

        function showLoginModal() {
            if (elements.loginModal) {
                elements.loginModal.classList.add('active');
                elements.adminPasswordInput.value = '';
                elements.loginError.style.display = 'none';
            }
        }

        function hideLoginModal() {
            if (elements.loginModal) elements.loginModal.classList.remove('active');
        }

        function handleAdminLogin() {
            const password = elements.adminPasswordInput?.value || '';
            if (password === appState.adminPassword) {
                appState.isAdmin = true;
                hideLoginModal();
                showAdminPanel();
                showNotification('Admin access granted!', 'success');
            } else {
                elements.loginError.style.display = 'block';
                elements.adminPasswordInput.value = '';
            }
        }

        function showAdminPanel() {
            if (elements.adminPanel) elements.adminPanel.classList.add('active');
        }

        function hideAdminPanel() {
            if (elements.adminPanel) elements.adminPanel.classList.remove('active');
        }

        // ==================== GITHUB EXPORT ====================

        function exportDataForGitHub() {
            const dataToExport = {
                days: appState.days,
                currentDay: appState.currentDay
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'racing_leaderboard_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported! Upload this JSON file to GitHub.', 'success');
        }

        // ==================== NOTIFICATION SYSTEM ====================

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ==================== INITIALIZE APPLICATION ====================

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
